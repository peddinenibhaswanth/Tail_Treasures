<div class="row">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Information</h4>
      </div>
      <div class="card-body">
        <form action="/checkout" method="POST" id="checkoutForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="name" name="name" value="<%= currentUser.name %>" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email" value="<%= currentUser.email %>" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="phone" name="phone" value="<%= currentUser.phone || '' %>" required>
          </div>
          
          <div class="mb-3">
            <label for="street" class="form-label">Street Address</label>
            <input type="text" class="form-control" id="street" name="street" value="<%= currentUser.address ? currentUser.address.street : '' %>" required>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="city" class="form-label">City</label>
              <input type="text" class="form-control" id="city" name="city" value="<%= currentUser.address ? currentUser.address.city : '' %>" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="state" class="form-label">State/Province</label>
              <input type="text" class="form-control" id="state" name="state" value="<%= currentUser.address ? currentUser.address.state : '' %>" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="zipCode" class="form-label">Zip/Postal Code</label>
              <input type="text" class="form-control" id="zipCode" name="zipCode" value="<%= currentUser.address ? currentUser.address.zipCode : '' %>" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="country" class="form-label">Country</label>
              <input type="text" class="form-control" id="country" name="country" value="<%= currentUser.address ? currentUser.address.country : '' %>" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="notes" class="form-label">Order Notes (Optional)</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
          
          <hr>
          
          <h5 class="mb-3">Payment Method</h5>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="credit card" checked>
              <label class="form-check-label" for="creditCard">
                <i class="far fa-credit-card me-2"></i>Credit Card
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod" id="paypal" value="paypal">
              <label class="form-check-label" for="paypal">
                <i class="fab fa-paypal me-2"></i>PayPal
              </label>
            </div>
          </div>
          
          <div id="creditCardDetails">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="cardName" class="form-label">Name on Card</label>
                <input type="text" class="form-control" id="cardName" name="cardName">
              </div>
              <div class="col-md-6 mb-3">
                <label for="cardNumber" class="form-label">Card Number</label>
                <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="XXXX XXXX XXXX XXXX">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="expiryMonth" class="form-label">Expiry Month</label>
                <select class="form-select" id="expiryMonth" name="expiryMonth">
                  <option value="">Month</option>
                  <% for (let i = 1; i <= 12; i++) { %>
                    <option value="<%= i %>"><%= i.toString().padStart(2, '0') %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="expiryYear" class="form-label">Expiry Year</label>
                <select class="form-select" id="expiryYear" name="expiryYear">
                  <option value="">Year</option>
                  <% const currentYear = new Date().getFullYear(); %>
                  <% for (let i = currentYear; i <= currentYear + 10; i++) { %>
                    <option value="<%= i %>"><%= i %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="cvv" class="form-label">CVV</label>
                <input type="text" class="form-control" id="cvv" name="cvv" placeholder="XXX">
              </div>
            </div>
          </div>
          
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="/cart" class="btn btn-outline-secondary">Back to Cart</a>
            <button type="button" id="proceedToPaymentBtn" class="btn btn-success">Proceed to Payment</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Order Summary</h5>
      </div>
      <div class="card-body">
        <% if (cart && cart.items && cart.items.length > 0) { %>
          <div class="mb-3">
            <% cart.items.forEach(item => { %>
              <div class="d-flex mb-2">
                <img src="<%= item.product.mainImage %>" alt="<%= item.product.name %>" class="img-thumbnail me-2" style="width: 50px; height: 50px; object-fit: cover;">
                <div>
                  <h6 class="mb-0"><%= item.product.name %></h6>
                  <small class="text-muted">Qty: <%= item.quantity %> x $<%= (item.product.onSale ? item.product.salePrice : item.product.price).toFixed(2) %></small>
                </div>
                <div class="ms-auto">
                  $<%= ((item.product.onSale ? item.product.salePrice : item.product.price) * item.quantity).toFixed(2) %>
                </div>
              </div>
            <% }); %>
          </div>
          
          <hr>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <span>$<%= (cart?.subtotal || 0).toFixed(2) %></span>
          </div>
          <% if (cart.discount > 0) { %>
            <div class="d-flex justify-content-between mb-2 text-danger">
              <span>Discount:</span>
              <span>-$<%= cart.discount.toFixed(2) %></span>
            </div>
          <% } %>
          <div class="d-flex justify-content-between mb-2">
            <span>Shipping:</span>
            <% if (cart.subtotal >= 50) { %>
              <span class="text-success">Free</span>
            <% } else { %>
              <span>$<%= cart.shipping.toFixed(2) %></span>
            <% } %>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Tax (8%):</span>
            <span>$<%= cart.tax.toFixed(2) %></span>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-3">
            <strong>Total:</strong>
            <strong>$<%= cart.total.toFixed(2) %></strong>
          </div>
        <% } else { %>
          <p class="text-center">Your cart is empty</p>
          <div class="d-grid">
            <a href="/products" class="btn btn-primary">Browse Products</a>
          </div>
        <% } %>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Need Help?</h5>
      </div>
      <div class="card-body">
        <p><i class="fas fa-phone me-2"></i>Call us: (123) 456-7890</p>
        <p><i class="fas fa-envelope me-2"></i>Email: support@petadopt.com</p>
        <p><i class="fas fa-clock me-2"></i>Hours: Mon-Fri, 9am-5pm</p>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="paymentModalLabel">Complete Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="fas fa-lock fa-3x text-success mb-3"></i>
          <h4>Secure Payment</h4>
          <p class="text-muted">Your payment information is secure. We use encryption to protect your data.</p>
        </div>
        
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title">Order Summary</h6>
            <div class="d-flex justify-content-between mb-2">
              <span>Total Amount:</span>
              <span class="fw-bold">$<%= (cart?.total || 0).toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Payment Method:</span>
              <span id="paymentMethodDisplay">Credit Card</span>
            </div>
          </div>
        </div>
        
        <div id="paymentProcessing" class="text-center d-none">
          <div class="spinner-border text-success mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Processing your payment...</p>
        </div>
        
        <div id="paymentSuccess" class="text-center d-none">
          <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
          <h4>Payment Successful!</h4>
          <p>Your order has been placed successfully.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="payNowBtn" class="btn btn-success">Pay Now</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const paymentMethod = document.querySelectorAll('input[name="paymentMethod"]');
    const creditCardDetails = document.getElementById('creditCardDetails');
    const paymentMethodDisplay = document.getElementById('paymentMethodDisplay');
    const checkoutForm = document.getElementById('checkoutForm');
    const proceedToPaymentBtn = document.getElementById('proceedToPaymentBtn');
    const payNowBtn = document.getElementById('payNowBtn');
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    const paymentProcessing = document.getElementById('paymentProcessing');
    const paymentSuccess = document.getElementById('paymentSuccess');
    
    // Toggle credit card details based on payment method
    paymentMethod.forEach(function(method) {
      method.addEventListener('change', function() {
        if (this.value === 'credit card') {
          creditCardDetails.style.display = 'block';
          paymentMethodDisplay.textContent = 'Credit Card';
        } else {
          creditCardDetails.style.display = 'none';
          paymentMethodDisplay.textContent = 'PayPal';
        }
      });
    });
    
    // Proceed to payment button
    proceedToPaymentBtn.addEventListener('click', function() {
      // Validate form
      if (!validateForm()) {
        return;
      }
      
      // Show payment modal
      paymentModal.show();
    });
    
    // Pay now button
    payNowBtn.addEventListener('click', function() {
      // Show processing
      paymentProcessing.classList.remove('d-none');
      payNowBtn.disabled = true;
      
      // Simulate payment processing
      setTimeout(function() {
        // Hide processing, show success
        paymentProcessing.classList.add('d-none');
        paymentSuccess.classList.remove('d-none');
        payNowBtn.style.display = 'none';
        
        // Submit form after 2 seconds
        setTimeout(function() {
          checkoutForm.action = "/orders/checkout";
          checkoutForm.submit();
        }, 2000);
      }, 2000);
    });
    
    // Form validation
    function validateForm() {
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const street = document.getElementById('street').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const zipCode = document.getElementById('zipCode').value;
      const country = document.getElementById('country').value;
      
      if (!name || !email || !phone || !street || !city || !state || !zipCode || !country) {
        alert('Please fill in all required fields');
        return false;
      }
      
      const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
      
      if (selectedPaymentMethod === 'credit card') {
        const cardName = document.getElementById('cardName').value;
        const cardNumber = document.getElementById('cardNumber').value;
        const expiryMonth = document.getElementById('expiryMonth').value;
        const expiryYear = document.getElementById('expiryYear').value;
        const cvv = document.getElementById('cvv').value;
        
        if (!cardName || !cardNumber || !expiryMonth || !expiryYear || !cvv) {
          alert('Please fill in all credit card details');
          return false;
        }
        
        // Basic card number validation
        if (!/^\d{16}$/.test(cardNumber.replace(/\s/g, ''))) {
          alert('Please enter a valid 16-digit card number');
          return false;
        }
        
        // Basic CVV validation
        if (!/^\d{3,4}$/.test(cvv)) {
          alert('Please enter a valid CVV (3 or 4 digits)');
          return false;
        }
      }
      
      return true;
    }
  });
</script>
