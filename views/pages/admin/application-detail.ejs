<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-0">Application Details</h2>
      <p class="text-muted">Review adoption application</p>
    </div>
    <div class="col-auto">
      <a href="/admin/applications" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Applications
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Application Information</h5>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Application ID</h6>
              <p><%= application._id %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Status</h6>
              <% if (application.status === 'submitted') { %>
                <span class="badge bg-primary">Submitted</span>
              <% } else if (application.status === 'under review') { %>
                <span class="badge bg-warning text-dark">Under Review</span>
              <% } else if (application.status === 'approved') { %>
                <span class="badge bg-success">Approved</span>
              <% } else if (application.status === 'denied') { %>
                <span class="badge bg-danger">Denied</span>
              <% } %>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Submitted On</h6>
              <p><%= new Date(application.createdAt).toLocaleString() %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Last Updated</h6>
              <p><%= new Date(application.updatedAt).toLocaleString() %></p>
            </div>
          </div>

          <hr>

          <h5 class="mb-3">Applicant Information</h5>
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Name</h6>
              <p><%= application.adopter.name %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Email</h6>
              <p><%= application.adopter.email %></p>
            </div>
          </div>

          <hr>

          <h5 class="mb-3">Pet Information</h5>
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Pet Name</h6>
              <p><%= application.pet.name %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Species</h6>
              <p><%= application.pet.species %></p>
            </div>
          </div>
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Breed</h6>
              <p><%= application.pet.breed %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Age</h6>
              <p><%= application.pet.age.value %> <%= application.pet.age.unit %></p>
            </div>
          </div>

          <hr>

          <h5 class="mb-3">Application Details</h5>
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Home Type</h6>
              <p><%= application.homeType.charAt(0).toUpperCase() + application.homeType.slice(1) %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Has Yard</h6>
              <p><%= application.hasYard ? 'Yes' : 'No' %></p>
            </div>
          </div>
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Has Children</h6>
              <p><%= application.hasChildren ? 'Yes' : 'No' %></p>
            </div>
            <% if (application.hasChildren && application.childrenAges) { %>
              <div class="col-md-6">
                <h6 class="text-muted mb-2">Children Ages</h6>
                <p><%= application.childrenAges %></p>
              </div>
            <% } %>
          </div>
          <div class="row mb-4">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Has Other Pets</h6>
              <p><%= application.hasOtherPets ? 'Yes' : 'No' %></p>
            </div>
            <% if (application.hasOtherPets && application.otherPetsDescription) { %>
              <div class="col-md-6">
                <h6 class="text-muted mb-2">Other Pets Description</h6>
                <p><%= application.otherPetsDescription %></p>
              </div>
            <% } %>
          </div>
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-muted mb-2">Work Schedule</h6>
              <p><%= application.workSchedule %></p>
            </div>
          </div>
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-muted mb-2">Experience with Pets</h6>
              <p><%= application.experience %></p>
            </div>
          </div>
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="text-muted mb-2">Reason for Adopting</h6>
              <p><%= application.reasonForAdopting %></p>
            </div>
          </div>
          <% if (application.additionalInfo) { %>
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-muted mb-2">Additional Information</h6>
                <p><%= application.additionalInfo %></p>
              </div>
            </div>
          <% } %>
          <% if (application.status === 'denied' && application.denialReason) { %>
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-muted mb-2">Denial Reason</h6>
                <p class="text-danger"><%= application.denialReason %></p>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
          <% if (application.status === 'submitted' || application.status === 'under review') { %>
            <div class="d-grid gap-2 mb-3">
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal">
                <i class="fas fa-check me-2"></i>Approve Application
              </button>
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#denyModal">
                <i class="fas fa-times me-2"></i>Deny Application
              </button>
            </div>
            <% if (application.status === 'submitted') { %>
              <form action="/admin/applications/<%= application._id %>/mark-under-review" method="POST">
                <div class="d-grid">
                  <button type="submit" class="btn btn-warning">
                    <i class="fas fa-search me-2"></i>Mark as Under Review
                  </button>
                </div>
              </form>
            <% } %>
          <% } else { %>
            <div class="alert alert-info mb-0">
              <i class="fas fa-info-circle me-2"></i>This application has been <%= application.status %>.
            </div>
          <% } %>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">Applicant Details</h5>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <img src="<%= application.adopter.profileImage %>" alt="<%= application.adopter.name %>" class="rounded-circle img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
            <h5 class="mt-2 mb-0"><%= application.adopter.name %></h5>
            <p class="text-muted"><%= application.adopter.email %></p>
          </div>
          <div class="d-grid">
            <a href="/admin/users/<%= application.adopter._id %>" class="btn btn-outline-primary">
              <i class="fas fa-user me-2"></i>View Full Profile
            </a>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Pet Details</h5>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <img src="<%= application.pet.mainImage %>" alt="<%= application.pet.name %>" class="img-thumbnail" style="width: 150px; height: 150px; object-fit: cover;">
            <h5 class="mt-2 mb-0"><%= application.pet.name %></h5>
            <p class="text-muted"><%= application.pet.breed %>, <%= application.pet.age.value %> <%= application.pet.age.unit %></p>
          </div>
          <div class="d-grid">
            <a href="/pets/<%= application.pet._id %>" class="btn btn-outline-primary">
              <i class="fas fa-paw me-2"></i>View Pet Profile
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approveModalLabel">Confirm Approval</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to approve this application?</p>
        <p>This will mark the pet as adopted and notify the applicant.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/admin/applications/<%= application._id %>/approve" method="POST">
          <button type="submit" class="btn btn-success">Approve Application</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Deny Modal -->
<div class="modal fade" id="denyModal" tabindex="-1" aria-labelledby="denyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="denyModalLabel">Confirm Denial</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/admin/applications/<%= application._id %>/deny" method="POST">
        <div class="modal-body">
          <p>Are you sure you want to deny this application?</p>
          <div class="mb-3">
            <label for="denialReason" class="form-label">Reason for denial:</label>
            <textarea class="form-control" id="denialReason" name="denialReason" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Deny Application</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('../../partials/admin-footer') %>
